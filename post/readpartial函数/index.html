
<!DOCTYPE html>
<html lang="zh">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="Rubyist, Python, JavaScript" name="keywords">
<meta name="description" content="renyijiu&#39;s blog!">

<meta content="readpartialå‡½æ•° - renyijiu" property="og:title">
<title>readpartialå‡½æ•° | renyijiu</title>
<link rel="shortcut ico" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="/css/style.css">

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://yijiu.ren"><h1 class="title is-4">renyijiu</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/renyijiu">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="/about">
            <span class="icon">
              <i class="fa fa-user"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">August 13, 2017</h2>
    <h1 class="title">readpartialå‡½æ•°</h1>
    
    <div class="content">
      <p>å‰é¢åœ¨è°ƒè¯•ä¸€ä¸ªæ¥å£æ—¶ï¼Œè‡ªå·±åœ¨æœ¬åœ°è·‘æµ‹è¯•æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒåæµ‹è¯•å‘ç°æŠ¥ç¼–ç é”™è¯¯ï¼Œ<code>Encoding::UndefinedConversionError: &quot;\xE6&quot; from ASCII-8BIT to UTF-8</code>ã€‚è‡ªå·±ä¹Ÿæ¯”è¾ƒå¥‡æ€ªé—®é¢˜çš„å‘ç”Ÿï¼Œå› ä¸ºrubyåœ¨ç¼–ç é—®é¢˜ä¸Šå…¶å®åšäº†å¾ˆå¤šçš„è‡ªåŠ¨è½¬æ¢ï¼Œæ‰€ä»¥ç¢°åˆ°çš„å¹¶ä¸å¤šï¼ˆå½“ç„¶å¦‚æœä½ è¦æ˜¯ä½ ç”¨python2å†™è¿‡ç½‘é¡µçš„æŠ“å–ï¼Œå°±çŸ¥é“ç½‘é¡µç¼–ç é”™è¯¯ç»™æ–°æ‰‹å¸¦æ¥çš„ææƒ§æ„ŸğŸ˜± )ã€‚å¦å¤–è¿™ä¸ªä¹Ÿä¸æ‰€è¿è¡Œçš„æœºå™¨è®¾ç½®æœ‰å…³ï¼Œè¿™ä¸ªåœ¨è¿™å°±ä¸æ¢è®¨äº†ã€‚è¿™é‡Œåº”è¯¥å°±æ˜¯æœºå™¨æ–‡ä»¶é…ç½®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æœ¬åœ°æµ‹è¯•å¹¶æ²¡æœ‰å‘ç°ã€‚è¿™é‡Œä¸»è¦é€šè¿‡ä¿®æ”¹è¾“å‡ºç¼–ç è¿›è¡Œé—®é¢˜ä¿®å¤ã€‚</p>

<h4 id="é—®é¢˜è¿‡ç¨‹">é—®é¢˜è¿‡ç¨‹</h4>

<p>æŸ¥çœ‹ä»£ç å®šä½åˆ°ä¸‹é¢ä¸€æ®µä»£ç ï¼Œ</p>

<pre><code class="language-ruby">...
res_body = HTTP.get('http://news.baidu.com').body
res = ''

while tmp = res_body.readpartial
  res &lt;&lt; tmp
end

res
</code></pre>

<p>ä»£ç ä¸Šæ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨äº†<code>http</code>è¿™ä¸ªgemåŒ…ï¼Œç„¶åè¯»å–è¯·æ±‚çš„è¿”å›æ•°æ®ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚è€Œå…¶ä¸­readpartialå‡½æ•°å°±æ˜¯è¯»å–æ•°æ®æµçš„è¿‡ç¨‹ï¼ŒæŸ¥çœ‹æ–‡æ¡£å¯ä»¥å‘ç°</p>

<pre><code>readpartial(maxlen) â†’ string
Reads at most maxlen bytes from the I/O stream.

ä»streamä¸­è¯»å–è¯»å–è®¾å®šçš„å­—èŠ‚ï¼Œé»˜è®¤å€¼åº”è¯¥æ˜¯4096.
</code></pre>

<p>ä¸‹é¢æ˜¯ç¤ºä¾‹ï¼š</p>

<pre><code>irb(main):001:0&gt; require 'http'
=&gt; true
irb(main):002:0&gt; a = HTTP.get('http://news.baidu.com')
=&gt; #&lt;HTTP::Response/1.1 200 OK {&quot;Content-Type&quot;=&gt;&quot;text/html;charset=utf-8&quot;, &quot;Date&quot;=&gt;&quot;Sun, 13 Aug 2017 07:13:38 GMT&quot;, &quot;P3p&quot;=&gt;&quot;CP=\&quot; OTI DSP COR IVA OUR IND COM \&quot;&quot;, &quot;Server&quot;=&gt;&quot;Apache&quot;, &quot;Set-Cookie&quot;=&gt;&quot;BAIDUID=2566632A5C67FBC740BA9306D2FCB7FD:FG=1; expires=Mon, 13-Aug-18 07:13:38 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1&quot;, &quot;Tracecode&quot;=&gt;[&quot;08188671830454104842081315&quot;, &quot;08188390610572470282081315&quot;], &quot;Vary&quot;=&gt;[&quot;Accept-Encoding&quot;, &quot;Accept-Encoding&quot;], &quot;Connection&quot;=&gt;&quot;close&quot;, &quot;Transfer-Encoding&quot;=&gt;&quot;chunked&quot;}&gt;
irb(main):003:0&gt; a.body
=&gt; #&lt;HTTP::Response::Body:3feb13b4e3b0 @streaming=false&gt;

</code></pre>

<p>è¿™é‡Œå°±å‡ºç°äº†å‡ ä¸ªé—®é¢˜:</p>

<ol>
<li><p>è¿™æ˜¯ä»¥å­—èŠ‚æ¨¡å¼è¯»å–æ•°æ®ï¼Œç¼–ç æ ¼å¼æ˜¯<code>ASCII-8BIT</code></p>

<pre><code>irb(main):005:0&gt; c = a.body.readpartial
=&gt; &quot;&lt;!doctype html&gt;\n&lt;html class=\&quot;expanded\&quot;&gt;\n&lt;head&gt;\n\n&lt;!--STATUS OK--&gt;...&quot;
irb(main):006:0&gt; c.encoding
=&gt; #&lt;Encoding:ASCII-8BIT&gt;
</code></pre></li>

<li><p>è®¾å®šmaxlenåä¼šæˆªæ–­æ•°æ®</p>

<p>å½“ä½ è®¾å®šäº†æœ€å¤§çš„è¯»å–é•¿åº¦åï¼Œå‡½æ•°ä¼šç›´æ¥å°†æ•°æ®æˆªæ–­ï¼Œæœ€æ˜æ˜¾çš„æ˜¯å­˜åœ¨æ±‰å­—æ—¶ï¼Œæ±‰å­—ä¸º&rsquo;\xE5&hellip;&lsquo;æ ¼å¼ï¼Œå¦‚æœé•¿åº¦åˆ°äº†è®¾å®šå€¼ï¼Œä¼šè¢«ç›´æ¥æˆªæ–­ï¼Œä¸è®ºæ˜¯ä¸æ˜¯å®Œæ•´çš„æ•°æ®ï¼Œå› æ­¤ä¼šå¯¼è‡´å‡ºé”™ã€‚å°¤å…¶æ˜¯å½“ä½ è¾¹è¯»è¾¹è¿›è¡Œè§£ææ—¶ï¼Œè¿™ä¸ªé—®é¢˜å°±ä¼šå±•ç°å‡ºæ¥äº†ã€‚</p></li>
</ol>

<h4 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h4>

<ol>
<li><p>ç›´æ¥ç²—æš´</p>

<p>ä½¿ç”¨<code>force_encoding('utf-8')</code>æ–¹æ³•å°†å¯¹è±¡çš„ç¼–ç è½¬æ¢æˆ<code>utf-8</code>(è¿™åº”è¯¥æ˜¯ç›®å‰æœ€é€‚ç”¨çš„ç¼–ç æ ¼å¼)ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸ç›´æ¥ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨ä¸€äº›æ— æ³•è½¬æ¢çš„å­—ç¬¦ï¼Œä¼šå¯¼è‡´å‡½æ•°è½¬æ¢é”™è¯¯ã€‚</p></li>

<li><p>ä¿®æ”¹é…ç½®</p>

<ol>
<li>å¯ä»¥ä¿®æ”¹æœºå™¨çš„é…ç½®ï¼Œè®¾ç½®<code>utf-8</code>ä½œä¸ºé»˜è®¤çš„ç¼–ç æ ¼å¼ï¼›</li>
<li>åœ¨æ–‡ä»¶çš„å¼€å¤´åŠ ä¸Š<code>#coding: utf-8</code>è®¾ç½®æ–‡ä»¶çš„é»˜è®¤ç¼–ç ï¼Œä¸è¿‡æ–°ç‰ˆæœ¬çš„rubyå·²ç»å°†<code>utf-8</code>ä½œä¸ºé»˜è®¤çš„æ–‡ä»¶ç¼–ç ï¼Œæ‰€ä»¥ç°åœ¨å‡ ä¹éƒ½å¿½ç•¥</li>
</ol></li>

<li><p>ä½¿ç”¨&rsquo;http&rsquo;è¿™ä¸ªgemåŒ…</p>

<p>æ ¹æ®&rsquo;http&rsquo;è¿™ä¸ªgemåŒ…çš„æŒ‡å¼•ï¼Œå¯ä»¥å‘ç°ï¼Œé™¤äº†readpartialè¿™ä¸ªè·å–bodyä¿¡æ¯æ–¹æ³•å¤–ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨<code>to_s</code>è·å–ï¼Œè·å–åˆ°çš„æ ¼å¼ä¸º<code>utf-8</code></p>

<pre><code>irb(main):027:0&gt; a.body.to_s.encoding
=&gt; #&lt;Encoding:UTF-8&gt;
</code></pre></li>
</ol>

<h4 id="æœ€å">æœ€å</h4>

<p>è¿™é‡Œåªæ˜¯ç®€å•çš„å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†åˆ†æï¼Œæœªæ¶‰åŠåˆ°ç›¸å…³çš„ç¼–ç çŸ¥è¯†ï¼Œå¦‚æœéœ€è¦äº†è§£å­¦ä¹ ï¼Œè¯·è‡ªå·±æŸ¥æ‰¾èµ„æ–™å­¦ä¹ ï¼Œç¼–ç è¿™ä¸€å—ä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ŒåŠ æ²¹å§ï¼</p>
    </div>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <P>Live For Dream, Dream For Love</P>
    <p>Hosted by <a href='https://pages.coding.me'>Coding Pages</a> &copy; <a href="https://yijiu.ren">renyijiu</a> 2017</p>
  </div>
</section>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" media="none" onload="if(media!='all')media='all'">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/atom-one-light.min.css" media="none" onload="if(media!='all')media='all'">

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/python.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/ruby.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-78885477-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



